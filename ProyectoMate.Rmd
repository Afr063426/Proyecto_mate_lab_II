---
title: "Proyecto"
author: "Daniel Sabater"
date: '2022-06-05'
output: html_document
---

```{r setup, include=FALSE}
#Programacion hecha por   Ricardo Acuña, Francisco Cambronero, Joshua Cervantes, Moisés Monge y Daniel Sabater
#Se cargan los paquetes
knitr::opts_chunk$set(echo = FALSE)
options(scipen = 999)
library(lifecontingencies)
library(tidyverse)
library(lubridate)
library(readxl)
library(kableExtra)
library(xtable)
library(stringr)
library(magrittr) # uso de %<>% con funciones de dplyr
#library(xts)
#library(tinytex)


#Se cargan las bases de datos

Afiliados_31_12_2021 <- read_excel("Planilla_Compañia_31_12_2021.xlsx")
Pensionados_31_12_2021 <- read_excel("Compañia_Pensionados_31_12_2021.xlsx",  range = "A1:F5006")


# Tablas de decrementos

TablasDecrementosHombres <- read_excel("Tablas de decrementos.xlsx", 
    sheet = "Hombres")
TablasDecrementosMujeres <- read_excel("Tablas de decrementos.xlsx", 
    sheet = "Mujeres")

# Tablas de mortalidad dinámicas

TablaDinamica_lxsHombres <- as.data.frame(read_excel("TablaDinamica-lxs.xls", 
    sheet = "Hombres"))
TablaDinamica_lxsMujeres <- as.data.frame(read_excel("TablaDinamica-lxs.xls", 
    sheet = "Mujeres"))

#Se genera lista con las tablas actuariales de los hombres

ListaDeTablasHombres <- list()
for (j in 1:(length(TablaDinamica_lxsHombres)-1)){
    
    ListaDeTablasHombres[[j]] <- with(TablaDinamica_lxsHombres,
                       new(
                         "actuarialtable",
                         interest = 0.06,
                         x = TablaDinamica_lxsHombres[,1],
                         lx = TablaDinamica_lxsHombres[,j+1] ,
                         name = paste("E",(j-1), sep = "")
                       ))
}
names(ListaDeTablasHombres)<-paste("E",seq(0,115), sep = "")

#Se genera lista con las tablas actuariales de las mujeres

ListaDeTablasMujeres <- list()
for (j in 1:(length(TablaDinamica_lxsMujeres)-1)){
    
    ListaDeTablasMujeres[[j]] <- with(TablaDinamica_lxsMujeres,
                       new(
                         "actuarialtable",
                         interest = 0.06,
                         x = TablaDinamica_lxsMujeres[,1],
                         lx = TablaDinamica_lxsMujeres[,j+1] ,
                         name = paste("E",(j-1), sep = "")
                       ))
}
names(ListaDeTablasMujeres)<-paste("E",seq(0,115), sep = "")

# Se establece la echa de la evaluación

dia_de_evaluacion <- as.Date('31/12/2021', format='%d/%m/%Y')

# Afiliados

# Cálculo de edades afiliados

edad <- floor(time_length(difftime(
  dia_de_evaluacion,
    as.Date(as.POSIXct(Afiliados_31_12_2021$Fecha_nacimiento),'UTC')),'years'))

# Depuración de la columna 'Fecha_ingreso' 

Afiliados_31_12_2021 %<>% mutate(Fecha_ingreso = paste(substr(Fecha_ingreso,1,4),
                    '/',substr(Fecha_ingreso,5,6),'/',substr(Fecha_ingreso,7,8),sep='')) 

# Depuración de la columna 'Fecha_nacimiento'

Afiliados_31_12_2021 %<>% mutate(Fecha_nacimiento = format(Fecha_nacimiento, '%Y/%m/%d')) 

# Cálculo de antigüedad

antiguedad <- time_length(difftime(
            dia_de_evaluacion,
            as.Date(Afiliados_31_12_2021$Fecha_ingreso,
            '%Y/%m/%d')), "years")

# Inclusión de las variables de edad y antigüedad en la base de datos

Afiliados_31_12_2021 %<>% mutate('Edad' = edad,'Antiguedad' = antiguedad)

#Se calcula edad de los pensionados

Pensionados_31_12_2021 %<>% mutate(FEC_NAC=paste(substr(FEC_NAC,1,4),
                    '/',substr(FEC_NAC,5,6),'/',substr(FEC_NAC,7,8),sep=''))

Pensionados_31_12_2021 %<>% mutate(FEC_RIG_PEN=paste(substr(FEC_RIG_PEN,1,4),
                    '/',substr(FEC_RIG_PEN,5,6),'/',substr(FEC_RIG_PEN,7,8),sep=''))

edad <- floor(time_length(difftime(
            dia_de_evaluacion,
            as.Date(Pensionados_31_12_2021$FEC_NAC,
            '%Y/%m/%d')),
            'years'))

tiempo_pension<-floor(time_length(difftime(
            dia_de_evaluacion,
            as.Date(Pensionados_31_12_2021$FEC_RIG_PEN,
            '%Y/%m/%d')),
            'years'))

Pensionados_31_12_2021 %<>% mutate('Edad'=edad,'T_Pension'=tiempo_pension)

#se crean bases de datos según genero

afil_hombres <- Afiliados_31_12_2021 %>% filter(Sexo == "M")
pen_hombres <- Pensionados_31_12_2021 %>% filter(SEX == "M")
afil_mujeres <- Afiliados_31_12_2021 %>% filter(Sexo == "F")
pen_mujeres <- Pensionados_31_12_2021 %>% filter(SEX == "F")

```


# Estadistica
```{r}
# Ejemplo esperanza de vida
Edad <- 30
exn(ListaDeTablasHombres[[Edad+1]], x = Edad, type = "curtate")
```



# Estocástico

```{r}

```





# Deterministico



# Funciones que nos sirven a ambos




```{r}
#porcentaje de pensión
porcentaje_de_pension <- function(antiguedad) {
  porcebtajeVejez<-c( (antiguedad >= 5  & antiguedad < 10) * 0.10 +
                      (antiguedad >= 10 & antiguedad < 15) * 0.15 +
                      (antiguedad >= 15 & antiguedad < 20) * 0.20 +
                      (antiguedad >= 20 & antiguedad < 25) * 0.25 +
                      (antiguedad >= 30 & antiguedad < 35) * 0.30 +
                      (antiguedad >= 35 & antiguedad < 40) * 0.35 +
                      (antiguedad >= 40) * 0.4
                    )
  return(porcebtajeVejez)
}

RebajoFondosInsuficientes <- function(MontodePension) {
  MontoRebajado<-c( 
     MontodePension*0.10+
    (MontodePension >= 2293400 ) * 0.35 * MontodePension+
    (MontodePension >= 2866750 ) * 0.45 * MontodePension+
    (MontodePension >= 3583437.50) * 0.55 * MontodePension+
    (MontodePension >= 4479296.88) * 0.65 *MontodePension
  )
  if (MontoRebajado>MontodePension*0.55) {
    return(MontoRebajado*0.55)
  }
  return(MontoRebajado)
}
```

## Personal activo

```{r}

```


## Personas ya pensionadas
```{r}


```








