---
title: "Proyecto"
author: "Daniel Sabater"
date: '2022-06-05'
output: html_document
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
# Programacion hecha por Joshua Cervantes, Moisés Monge y Daniel Sabater
# Se cargan los paquetes
knitr::opts_chunk$set(echo = FALSE)
options(scipen = 999)
library(lifecontingencies)
library(tidyverse)
library(lubridate)
library(readxl)
library(kableExtra)
library(xtable)
library(stringr)
library(magrittr) # uso de %<>% con funciones de dplyr


# Para paralelizar
library(future.apply)
plan(multicore)

# Se cargan las bases de datos

Afiliados_31_12_2021 <- read_excel("Planilla_Compañia_31_12_2021.xlsx")
Pensionados_31_12_2021 <- read_excel("Compañia_Pensionados_31_12_2021.xlsx", range = "A1:F5006")


# Tablas de decrementos

TablasDecrementosHombres <- read_excel("Tablas de decrementos.xlsx",
  sheet = "Hombres"
)
TablasDecrementosMujeres <- read_excel("Tablas de decrementos.xlsx",
  sheet = "Mujeres"
)


# Tablas de mortalidad dinámicas


TablaDinamica_lxsHombres <- as.data.frame(read_excel("TablaDinamica-lxs.xlsx",
  sheet = "Hombres"
))
TablaDinamica_lxsMujeres <- as.data.frame(read_excel("TablaDinamica-lxs.xlsx",
  sheet = "Mujeres"
))


# Se genera lista con las tablas actuariales de los hombres

ListaDeTablasHombres <- list()
for (j in 1:(length(TablaDinamica_lxsHombres) - 1)) {
  ListaDeTablasHombres[[j]] <- with(
    TablaDinamica_lxsHombres,
    new(
      "actuarialtable",
      interest = 0.06,
      x = TablaDinamica_lxsHombres[, 1],
      lx = TablaDinamica_lxsHombres[, j + 1],
      name = paste("E", (j - 1), sep = "")
    )
  )
}

names(ListaDeTablasHombres) <- paste("E", seq(0, 115), sep = "")

# Se genera lista con las tablas actuariales de las mujeres

ListaDeTablasMujeres <- list()
for (j in 1:(length(TablaDinamica_lxsMujeres) - 1)) {
  ListaDeTablasMujeres[[j]] <- with(
    TablaDinamica_lxsMujeres,
    new(
      "actuarialtable",
      interest = 0.06,
      x = TablaDinamica_lxsMujeres[, 1],
      lx = TablaDinamica_lxsMujeres[, j + 1],
      name = paste("E", (j - 1), sep = "")
    )
  )
}

names(ListaDeTablasMujeres) <- paste("E", seq(0, 115), sep = "")

# Se establece la fecha de la valuación

dia_de_evaluacion <- as.Date("31/12/2021", format = "%d/%m/%Y")

# Afiliados

# Cálculo de edades afiliados

edad <- floor(time_length(difftime(
  dia_de_evaluacion,
  as.Date(as.POSIXct(Afiliados_31_12_2021$Fecha_nacimiento), "UTC")
), "years"))

# Depuración de la columna 'Fecha_ingreso'

Afiliados_31_12_2021 %<>% mutate(Fecha_ingreso = paste(substr(Fecha_ingreso, 1, 4),
  "/", substr(Fecha_ingreso, 5, 6), "/", substr(Fecha_ingreso, 7, 8),
  sep = ""
))

# Depuración de la columna 'Fecha_nacimiento'

Afiliados_31_12_2021 %<>% mutate(Fecha_nacimiento = format(Fecha_nacimiento, "%Y/%m/%d"))

# Cálculo de antigüedad

antiguedad <- floor(time_length(difftime(
  dia_de_evaluacion,
  as.Date(
    Afiliados_31_12_2021$Fecha_ingreso,
    "%Y/%m/%d"
  )
), "years"))

# Inclusión de las variables de edad y antigüedad en la base de datos

Afiliados_31_12_2021 %<>% mutate("Edad" = edad, "Antiguedad" = antiguedad)

# Se calcula edad de los pensionados

Pensionados_31_12_2021 %<>% mutate(FEC_NAC = paste(substr(FEC_NAC, 1, 4),
  "/", substr(FEC_NAC, 5, 6), "/", substr(FEC_NAC, 7, 8),
  sep = ""
))

Pensionados_31_12_2021 %<>% mutate(FEC_RIG_PEN = paste(substr(FEC_RIG_PEN, 1, 4),
  "/", substr(FEC_RIG_PEN, 5, 6), "/", substr(FEC_RIG_PEN, 7, 8),
  sep = ""
))

edad <- floor(time_length(
  difftime(
    dia_de_evaluacion,
    as.Date(
      Pensionados_31_12_2021$FEC_NAC,
      "%Y/%m/%d"
    )
  ),
  "years"
))

tiempo_pension <- floor(time_length(
  difftime(
    dia_de_evaluacion,
    as.Date(
      Pensionados_31_12_2021$FEC_RIG_PEN,
      "%Y/%m/%d"
    )
  ),
  "years"
))

Pensionados_31_12_2021 %<>% mutate("Edad" = edad, "T_Pension" = tiempo_pension)

# se crean bases de datos según genero

afil_hombres <- Afiliados_31_12_2021 %>% filter(Sexo == "M")
pen_hombres <- Pensionados_31_12_2021 %>% filter(SEX == "M")
afil_mujeres <- Afiliados_31_12_2021 %>% filter(Sexo == "F")
pen_mujeres <- Pensionados_31_12_2021 %>% filter(SEX == "F")

# Inflacion
inflacion <- 0.04

# Aumentos real
aumento_real <- 0.0150

# Porcentaje de aporte
porcentaje_aporte <- 0.015

# Interes
interes <- 0.07

# Tablas de multiples decrementos
ProMuerte <- function(q1, q2, q3, q4) {
  a <- q1 * ((-3 * q2 * q3 * q4) / 12 + 4 * (q2 * q3 + q3 * q4 + q4 * q2) / 12 - 6 * (q2 + q3 + q4) / 12 + 1)
  b <- q2 * ((-3 * q1 * q3 * q4) / 12 + 4 * (q1 * q3 + q3 * q4 + q4 * q1) / 12 - 6 * (q1 + q3 + q4) / 12 + 1)
  c <- q3 * ((-3 * q2 * q1 * q4) / 12 + 4 * (q2 * q1 + q1 * q4 + q4 * q2) / 12 - 6 * (q2 + q1 + q4) / 12 + 1)
  d <- q4 * ((-3 * q2 * q3 * q1) / 12 + 4 * (q2 * q3 + q3 * q1 + q1 * q2) / 12 - 6 * (q2 + q3 + q1) / 12 + 1)
  qx <- (a + b + c + d)
  px<- 1-qx
  return(data.frame("qx1" = a, "qx2" = b, "qx3" = c, "qx4" = d, "qxC" = qx, "pxC" = px))
}

# Se genera lista con las tablas de multiples decrementos de los hombres

MDListaDeTablasHombres <- list()
for (m in 1:116) {
  qxs <- ProMuerte(TablasDecrementosHombres$Invalidez, TablasDecrementosHombres$Jubilacion, TablasDecrementosHombres$Retiro, qxt(ListaDeTablasHombres[[m]], 0:115, 1))

  
  Tabladevida <- as.data.frame(qxs)
  
  MDListaDeTablasHombres[[m]] <-Tabladevida

}

names(MDListaDeTablasHombres) <- paste("E", seq(0, 115), sep = "")



# Se genera lista con las tablas de multiples decrementos de las mujeres

MDListaDeTablasMujeres <- list()
for (m in 1:116) {
  qxs <- ProMuerte(TablasDecrementosMujeres$Invalidez, TablasDecrementosMujeres$Jubilacion, TablasDecrementosMujeres$Retiro, qxt(ListaDeTablasMujeres[[m]], 0, c(1:116)))

  Tabladevida <- as.data.frame(qxs)

  MDListaDeTablasMujeres[[m]] <-Tabladevida
}

names(MDListaDeTablasMujeres) <- paste("E", seq(0, 115), sep = "")

rm(qxs)
```

Las tablas de decrementos constituyen
 Decremento 1: invalidez
 Decremento 2: jubilación
 Decremento 3: retiro
 Decremento 4: muerte

```{r}
# Funciones para trabajar los decrementos
pxt1 <- function(tabla, x, t) {
  px<-numeric()
  if(length(x)==1){
    fn<-function(i){
      if (i==0) {
          return(1)
        }else{
          return(prod(tabla[x+(1:i),6]))
        }
    }
    
    px<-sapply(FUN=fn,X=t)
    return(px)
  }else if(length(x)>1){
    fn<-function(i){
      if (t==0) {
        return(1)
        }else{
          return(prod(tabla[i+(1:t),6]))
        }
      }
    px<-sapply(FUN=fn,X=x)
    return(px)
  }
}



qxt1 <- function(tabla, x, t, decrement= 5) {
  qx<-numeric()
  if(length(x)==1){
    fn<-function(i){
      if (i==0) {
        return(0)
        }else{
      return(sum(tabla[x+(1:i),decrement]*pxt1(tabla, x, (1:i)-1)))
      }}
    qx<-sapply(FUN=fn,X=t)
    return(qx)
  }else if(length(x)>1){
    fn<-function(i){
      if (t==0) {
        return(0)
        }else{
      return(sum(tabla[i+(1:t),decrement]*pxt1(tabla, i, (1:t)-1)))
      }}
    qx<-sapply(FUN=fn,X=x)
    return(qx)
  }
}
```


# Funciones que nos sirven a ambos

```{r}
# porcentaje de pensión
porcentaje_de_pension <- function(antiguedad) {
  porcebtajeVejez <- c(
    (antiguedad >= 5 & antiguedad < 10) * 0.10 +
    (antiguedad >= 10 & antiguedad < 15) * 0.15 +
    (antiguedad >= 15 & antiguedad < 20) * 0.20 +
    (antiguedad >= 20 & antiguedad < 25) * 0.25 +
    (antiguedad >= 25 & antiguedad < 30) * 0.30 +
    (antiguedad >= 30 & antiguedad < 35) * 0.35 +
    (antiguedad >= 35) * 0.4)

  return(porcebtajeVejez)
}


beneficio <- function(antiguedad, decremento, salario, k, n = 5) { 
  antiguedad <- antiguedad + k 
  # invalidez 
  if (decremento == 1) { 
    porcentaje_de_salario <- porcentaje_de_pension(antiguedad) * 0.6 
    # vejez 
  } else if (decremento == 2) { 
    porcentaje_de_salario <- porcentaje_de_pension(antiguedad) 
    # muerte 
  } else if (decremento == 4) { 
    porcentaje_de_salario <- porcentaje_de_pension(antiguedad) * 0.2 
  } 
  
  return(salario_referencia(antiguedad - k, salario, k, n) / 12 * porcentaje_de_salario) 
} 
 


RebajoFondosInsuficientes <- function(MontodePension) {
  MontoRebajado <- c(
    MontodePension * 0.10 +
      (MontodePension >= 2293400) * 0.35 * MontodePension +
      (MontodePension >= 2866750) * 0.45 * MontodePension +
      (MontodePension >= 3583437.50) * 0.55 * MontodePension +
      (MontodePension >= 4479296.88) * 0.65 * MontodePension
  )
  if (MontoRebajado > MontodePension * 0.55) {
    return(MontodePension * 0.55)
  }
  return(MontoRebajado)
}

salario_referencia <- function(antiguedad, salario, k, n = 5) { 
 
  # k es el tiempo hasta que ocurre un decremento o se llega a la edad máxima de jubilación 
 
  t <- max(-antiguedad, k - (n - 1)):k 
 
  s <- (length(t) - 1):0 
 
  salario_ref <- mean((1.025)^t * (1.04)^(t + s)) * 12 * salario 
 
  return(salario_ref) 
}

```

#Cambios a funciones

```{r}
porcentaje_de_pension <- function(antiguedad) {
    if(antiguedad>=5 && antiguedad < 35){
      return(antiguedad/100)
    }else if(antiguedad >= 35){
      return(0.4)
    }else if(antiguedad < 5){
      return(0)
    }
}

beneficio <- function(antiguedad, decremento, salario, k, n = 5) { 
  antiguedad <- antiguedad + k 
  # invalidez 
  if (decremento == 1) { 
    porcentaje_de_salario <- porcentaje_de_pension(antiguedad) * 0.6 
    # vejez 
  } else if (decremento == 2) { 
    porcentaje_de_salario <- porcentaje_de_pension(antiguedad) 
    # muerte 
  } else if (decremento == 4) { 
    porcentaje_de_salario <- porcentaje_de_pension(antiguedad) * 0.2 
  } 
  
  beneficio<-salario_referencia(antiguedad - k, salario, k, n) / 12 * porcentaje_de_salario
  beneficio<-min(beneficio, 1500000)
  return(beneficio) 
} 

```




## Calculo de pension estocastico



# Modelos Deterministicos


## Personas ya pensionadas

```{r}
# hombres
# PensionMensualDeterministico
## No es un seguro de vida completo y necesita diferimiento
PensionMensualDeterministico <-
  function(Edad, hombre, MontoDePension, tasa_descuento) {
    v <- (1) / (1 + tasa_descuento)
    # aguinlado
    MontoAPagar <- MontoDePension
    vectoraguinalado <- c(rep(0, 10), 1, 0)
    vectorMensual <- (seq(1 / 12, (115 - Edad + 1), 1 / 12))
    vectorAnualmensual <- sort(rep(c(0:(115 - Edad)), 12))

    if (hombre) {

      # anualidad inmediata
      anualidad <- pxt(ListaDeTablasHombres[[(Edad + 1)]], x = Edad, t = vectorMensual) *
        (v)^(vectorMensual)
      # monto a pagar con ajuste inflacionario
      MontoAPagar <- MontoAPagar * (1 + 0.04)^(vectorAnualmensual) * 2^(vectoraguinalado)
      suma <- anualidad * MontoAPagar
    } else {
      # anualidad inmediata
      anualidad <- pxt(ListaDeTablasMujeres[[(Edad + 1)]], x = Edad, t = vectorMensual) *
        (v)^(vectorMensual)
      # monto a pagar con ajuste inflacionario
      MontoAPagar <- MontoAPagar * (1 + 0.04)^(vectorAnualmensual) * 2^(vectoraguinalado)
      suma <- anualidad * MontoAPagar
    }
    suma <- sum(suma)
    return(suma)
  }
```

## Calculo para las pensiones de los ya pensionados

```{r}
# calculo de pensión para hombres pensionados
MontoDePensionMensualParaHombresDeterministicoPensionados <-
  mapply(
    PensionMensualDeterministico,
    pen_hombres$Edad,
    TRUE,
    pen_hombres$MON_PEN,
    0.07
  )
sum(MontoDePensionMensualParaHombresDeterministicoPensionados)

# calculo de pensión para mujeres pensionados
MontoDePensionMensualParaMujeresDeterministicoPensionados <-
  mapply(
    PensionMensualDeterministico,
    pen_mujeres$Edad,
    FALSE,
    pen_mujeres$MON_PEN,
    0.07
  )
sum(MontoDePensionMensualParaMujeresDeterministicoPensionados)
```

## Personal activo
Deterministico para no pensionadas
Funciones a utilizar

### Funcion decremento Invalidez y Vejez

```{r}
# Optimizacion de la funcion 
DecrementosIV <- function(Edad, hombre, antiguedad, ultimo_salario, tasa_descuento, tasa_cre_salario, decremento, n = 0, promedioDeAnos=5) { 
  # Se va generar una tabla con los montos definidos para cada edad de pension 
  montos_pension <- list() 
  v <- (1) / (1 + tasa_descuento) 
  edades <- min(Edad):max(Edad) 
 
  # La funcion beneficio aun no ha sido definida 
  vectoraguinaldo <- c(rep(0, 10), 1, 0) 
  for (i in edades) { 
    # Tamaño del vector y posiciones, se va pasar como k 
    j <- (0:((115 - i) * (n == 0) + n)) 
    # Vector donde se van guardando los valores sin tener en cuenta el monto de beneficio, esto ya que se le multiplicará a cada individuo 
    # PV_aux <- numeric(length(j)) 
    # Funcion para estimar cada entrada del PV,  que corresponden 
    # a cada uno 
    funcion_pv <- function(k) { 
      PV_aux <- 0 
      if (hombre) { 
        # Vector al que se eleva el v 
        vectorMensual <- (seq(1 / 12, (115 - i + 1 - k), 1 / 12)) 
        # Vector para controlar la inflacion 
        vectorAnualmensual <- sort(rep(c(0:(115 - i - k)), 12)) 
        # Vector que contiene los montontos a pagar esto es los montos ajustados por inflacion y multiplicados 
        # por si se debería calcular el aguinaldo 
        MontoAPagar <- (1 + 0.04)^(vectorAnualmensual) * 2^vectoraguinaldo 
        # Vector multiplicando las probabilidad de sobrevivencia es decir tpx*v^t/m 
        anualidad <- pxt(ListaDeTablasHombres[[(i + 1)]], x = i + k + 1, t = vectorMensual) * (v)^(vectorMensual) 
        # Multiplicando ambos 
        suma1 <- sum(anualidad * MontoAPagar) 
        PV_aux <- suma1 * v^(k + 1) * pxt1(MDListaDeTablasHombres[[i + 1]], x = i, t = k) * qxt1(MDListaDeTablasHombres[[i + 1]], x = i + k, t = 1, decrement = decremento) 
      } else { 
        # Vector al que se eleva el v 
        vectorMensual <- (seq(1 / 12, (115 - i + 1 - k), 1 / 12)) 
        # Vector para controlar la inflacion 
        vectorAnualmensual <- sort(rep(c(0:(115 - i - k)), 12)) 
        # Vector que contiene los montontos a pagar esto es los montos ajustados por inflacion y multiplicados 
        # por si se debería calcular el aguinaldo 
        MontoAPagar <- (1 + 0.04)^(vectorAnualmensual) * 2^vectoraguinaldo 
        # Vector multiplicando las probabilidad de sobrevivencia es decir tpx*v^t/m 
        anualidad <- pxt(ListaDeTablasMujeres[[(i + 1)]], x = i + k + 1, t = vectorMensual) * (v)^(vectorMensual) 
        # Multiplicando ambos 
        suma1 <- sum(anualidad * MontoAPagar) 
        PV_aux <- suma1 * v^(k + 1) * pxt1(MDListaDeTablasMujeres[[i + 1]], x = i, t = k) * qxt1(MDListaDeTablasMujeres[[i + 1]], x = i + k, t = 1, decrement = decremento) 
      } 
      return(PV_aux) 
    } 
    montos_pension[[i - min(Edad) + 1]] <- sapply(FUN = funcion_pv, X = j) 
  } 
  # Se procede a programar una funcion la cual permite estimar el valor de los individuos 
  costo_individuo <- function(edad, antiguedad, ultimo_salario) { 
    # Se carga la lista de acuerdo a la edad 
    lista <- montos_pension[[edad - min(Edad) + 1]] 
    j <- (0:((115 - edad) * (n == 0) + n)) 
    # Salarios de referencia 
    salarios_ref <- unlist(sapply( 
      FUN = beneficio, antiguedad = antiguedad, 
      decremento = decremento, salario = ultimo_salario, X = j, n= promedioDeAnos 
    )) 
    # print(length(lista)) 
    # print(length(salarios_ref)) 
    # print(paste(salarios_ref, lista)) 
    # Se regresa el monto total de los beneficios otorgados 
    return(sum(salarios_ref * lista)) 
  } 
  PV <- unlist(mapply(FUN = costo_individuo, edad = Edad, antiguedad = antiguedad, ultimo_salario = ultimo_salario)) 
  return(PV) 
} 
```

## Funcion decremento muerte

```{r}
# Esta es la funcion de decremento por muerte
DecrementoM <- function(Edad, hombre, antiguedad, ultimo_salario, tasa_descuento, tasa_cre_salario, n = 0) { 
  v <- (1) / (1 + tasa_descuento) 
  edades <- min(Edad):max(Edad) 
  montos_pension <- list()
  vectoraguinaldo <- c(rep(0, 10), 1, 0) 
  vectorMensual <- seq(1 / 12, 10, 1 / 12) 
  vectorAnualmensual <- sort(rep(c(0:9), 12)) 
  for (i in edades) { 
    if (n != 0) { 
      n <- min(((85 - i) * hombre + (77 - i) * !hombre), n) 
    } 
    j <- (0:(((85 - i) * hombre + (77 - i) * !hombre) * (n == 0) + n)) 
    if (hombre) { 
      function_pv <- function(k) { 
        MontoPagar <- (1 + 0.04)^(vectorAnualmensual) * 2^vectoraguinaldo 
        suma1 <- sum((v)^(vectorMensual) * MontoPagar) 
 
 
        PV_aux <- suma1 * v^(k + 1) * pxt1(MDListaDeTablasHombres[[i + 1]], x = i, t = k) * 
          qxt1(MDListaDeTablasHombres[[i + 1]], x = i + k, t = 1, decrement = 4) 
 
        return(PV_aux) 
      } 
    } else { 
      function_pv <- function(k) { 
        MontoPagar <- (1 + 0.04)^(vectorAnualmensual) * 2^vectoraguinaldo 
        suma1 <- sum((v)^(vectorMensual) * MontoPagar) 
 
        PV_aux <- suma1 * v^(k + 1) * pxt1(MDListaDeTablasMujeres[[i + 1]], x = i, t = k) * 
          qxt1(MDListaDeTablasMujeres[[i + 1]], x = i + k, t = 1, decrement = 4) 
        return(PV_aux) 
      } 
    } 
    montos_pension[[i - min(Edad) + 1]] <- sapply(FUN = function_pv, X = j) 
  } 
  costo_individuo <- function(edad, antiguedad, ultimo_salario) { 
    # Se carga la lista de acuerdo a la edad 
    lista <- montos_pension[[edad - min(Edad) + 1]] 
    if (n != 0) { 
      n <- min(((85 - edad) * hombre + (77 - edad) * !hombre), n) 
    } 
    j <- (0:(((85 - edad) * hombre + (77 - edad) * !hombre) * (n == 0) + n)) 
    # Salarios de referencia 
    salarios_ref <- unlist(sapply( 
      FUN = beneficio, antiguedad = antiguedad, 
      decremento = 4, salario = ultimo_salario, X = j, n=promedioDeAnos
    )) 
    # print(paste(salarios_ref, lista)) 
    # Se regresa el monto total de los beneficios otorgados 
    return(sum(salarios_ref * lista)) 
  } 
  PV <- unlist(mapply(FUN = costo_individuo, edad = Edad, antiguedad = antiguedad, ultimo_salario = ultimo_salario)) 
  return(PV) 
} 

```


## Calculo de personas activas IVM


```{r} 
# Calculo de lo montos para hombres 
edades_h <- afil_hombres$Edad 
antiguedades_h <- afil_hombres$Antiguedad 
salarios_h <- afil_hombres$Salario 
tasa_descuento <- 0.07 
tasa_crecimiento_r <- 0 

# Por invalidez 
salida_invalidez_h <- DecrementosIV(edades_h, TRUE, antiguedades_h, salarios_h, tasa_descuento, tasa_crecimiento_r, 1) 
# Por jubilacion 
salida_jubilacion_h <- DecrementosIV(edades_h, TRUE, antiguedades_h, salarios_h, tasa_descuento, tasa_crecimiento_r, 2)
# Por muerte 
salida_muerte_h <- DecrementoM(edades_h, TRUE, antiguedades_h, salarios_h, tasa_descuento, tasa_crecimiento_r) 
 
salida_total_hombres <- salida_invalidez_h + salida_jubilacion_h + salida_muerte_h 
 
afil_hombres$Costo_plan <- salida_total_hombres

sum(salida_invalidez_h)
sum(salida_jubilacion_h)
sum(salida_muerte_h)
sum(afil_hombres$Costo_plan)

### Mujeres
edades_m <- afil_mujeres$Edad 
antiguedades_m <- afil_mujeres$Antiguedad 
salarios_m <- afil_mujeres$Salario 
tasa_descuento <- 0.07 
tasa_crecimiento_r <- 0 
# Calculo de lo montos para muejeres 
# Por invalidez 
salida_invalidez_m <- DecrementosIV(edades_m, FALSE, antiguedades_m, salarios_m, 0.07, 0, 1) 
 # Por jubilacion 
salida_jubilacion_m <- DecrementosIV(edades_m, FALSE, antiguedades_m, salarios_m, 0.07, 0, 2) 
 # Por muerte 
salida_muerte_m <- DecrementoM(edades_m, FALSE, antiguedades_m, salarios_m, tasa_descuento, tasa_crecimiento_r) 
 
 
salida_total_mujeres <- salida_invalidez_m + salida_jubilacion_m + salida_muerte_m 
 
afil_mujeres$Costo_plan <- salida_total_mujeres


sum(salida_invalidez_m)
sum(salida_jubilacion_m)
sum(salida_muerte_m)
sum(afil_mujeres$Costo_plan)
CostoTotal<-sum(afil_mujeres$Costo_plan)+sum(afil_hombres$Costo_plan)
```







```{r}
#Funcion para calculo de reservas 
reservas <- function(edad, salario_actual, antiguedad, i, inflacion, aumento_real, porcentaje_aporte, sexo) { 
 
    v <- 1 / (1 + i) 
    # Para estimar el aumento que se le hizo al salario inicial hasta el momento 
    aumento <- (1 + inflacion) * (1 + aumento_real) 
 
    # Salario con el que se inició 
    salario_inicial <- salario_actual * (aumento)^(-antiguedad) * porcentaje_aporte 
 
    # Salarios que han sido pagados para el momento de la liquidación 
    salarios <- salario_inicial * aumento^(0:(antiguedad )) 
    salarios <- sort(rep(salarios, 12)) 
    # Se crea un vector con 12 salarios de cada año 
    descontado <- v^seq(1 / 12, antiguedad + 1, 1 / 12) * (1 + i)^(antiguedad + 1) 
 
    # Se multiplica el descontado con los salarios pagados 
    monto <- sum(salarios * descontado) 
    if (!sexo) { 
      p <- pxt1(MDListaDeTablasMujeres[[edad + 1]], x = edad, t = 2) 
    } else if (sexo) { 
      p <- pxt1(MDListaDeTablasHombres[[edad + 1]], x = edad, t = 2) 
    } 
    return(monto * p) 
   
} 
 
#Calculo de reservas hombres 
reservas_hombres<-mapply( 
  FUN = reservas, 
  edad = edades_h, salario_actual = salarios_h, antiguedad = antiguedades_h, 
  i = interes, inflacion = inflacion, aumento_real = aumento_real, porcentaje = porcentaje_aporte, 
  sexo = TRUE 
) 
#Calculo de reservas mujeres 
reservas_mujeres<-mapply( 
  FUN = reservas, 
  edad = edades_m, salario_actual = salarios_m, antiguedad = antiguedades_m, 
  i = interes, inflacion = inflacion, aumento_real = aumento_real, porcentaje = porcentaje_aporte, 
  sexo = FALSE 
) 
reserva_total<- sum(reservas_hombres)+sum(reservas_mujeres) 



aporte<- 0.05
#Calculo de reservas hombres al 5%
reservas_hombres_5<-mapply( 
  FUN = reservas, 
  edad = edades_h, salario_actual = salarios_h, antiguedad = antiguedades_h, 
  i = interes, inflacion = inflacion, aumento_real = aumento_real, porcentaje = aporte, 
  sexo = TRUE 
) 
#Calculo de reservas mujeres al 5%
reservas_mujeres_5<-mapply( 
  FUN = reservas, 
  edad = edades_m, salario_actual = salarios_m, antiguedad = antiguedades_m, 
  i = interes, inflacion = inflacion, aumento_real = aumento_real, porcentaje = aporte, 
  sexo = FALSE 
) 
#Reseva al 5%
reserva_total_5<- sum(reservas_hombres_5)+sum(reservas_mujeres_5) 
```





```{r}
liquidacion <- function(edad, salario_actual, antiguedad, i, inflacion, aumento_real, porcentaje_aporte, sexo) { 
  if (antiguedad + 2 <= 22) { 
    v <- 1 / (1 + i) 
    # Para estimar el aumento que se le hizo al salario inicial hasta el momento 
    aumento <- (1 + inflacion) * (1 + aumento_real) 
 
    # Salario con el que se inició 
    salario_inicial <- salario_actual * (aumento)^(-antiguedad) * porcentaje_aporte 
 
    # Salarios que han sido pagados para el momento de la liquidación 
    salarios <- salario_inicial * aumento^(0:(antiguedad + 2)) 
    salarios <- sort(rep(salarios, 12)) 
    # Se crea un vector con 12 salarios de cada año 
    descontado <- v^seq(1 / 12, antiguedad + 3, 1 / 12) * (1 + i)^(antiguedad + 1) 
 
    # Se multiplica el descontado con los salarios pagados 
    monto <- sum(salarios * descontado) 
    if (!sexo) { 
      p <- pxt1(MDListaDeTablasMujeres[[edad + 1]], x = edad, t = 2) 
    } else if (sexo) { 
      p <- pxt1(MDListaDeTablasHombres[[edad + 1]], x = edad, t = 2) 
    } 
    return(monto * p) 
  } else { 
    return(0) 
  } 
}
```






## Cotización futura
```{r}
cotizacionfutura <-
  function(Edad, hombre, ultimo_salario, t=117,porcentaje_aporte=1) {
    v <- (1) / (1 + 0.07 )
    if (hombre) {
      t<-min(85-Edad,t)
      salariosfuturos<-ultimo_salario * ((1 + 0.04)*(1+0.025))^(1:(t))*12*
        pxt1(MDListaDeTablasHombres[[Edad+1]], x = Edad, t = (1:t))* v^(0:(t-1))
        return(salariosfuturos*porcentaje_aporte)
      } else {
        t<-min(77-Edad,t)
      salariosfuturos<-ultimo_salario * ((1 + 0.04)*(1+0.025))^(1:(t))*12*
        pxt1(MDListaDeTablasMujeres[[Edad+1]], x = Edad, t = (1:t))* v^(0:(t-1))
        return(salariosfuturos*porcentaje_aporte)
      }  
    }


SalariosM<-mapply( cotizacionfutura,  afil_mujeres$Edad, FALSE, afil_mujeres$Salario)
SalariosH<-mapply( cotizacionfutura,  afil_hombres$Edad, TRUE, afil_hombres$Salario)

```




```{r}
ValorPresenteDeMasaSalarial<-(sum(unlist(SalariosM))+sum(unlist(SalariosH)))
reservaNecesaria<- CostoTotal-0.015*(sum(unlist(SalariosM))+sum(unlist(SalariosH)))

#Caso uno solo le dan un 0.053 del beneficio
pi_1<-(CostoTotal*0.08)/ValorPresenteDeMasaSalarial
#Caso uno solo le dan una reserva
pi_2<-(CostoTotal*0.525-reserva_total_5)/ValorPresenteDeMasaSalarial
pi_2
CostoTotal/ValorPresenteDeMasaSalarial
```









