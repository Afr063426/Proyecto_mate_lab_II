---
title: "Proyecto"
author: "Daniel Sabater"
date: '2022-06-05'
output: html_document
---

```{r setup, include=FALSE}
# Programacion hecha por Joshua Cervantes, Moisés Monge y Daniel Sabater
# Se cargan los paquetes
knitr::opts_chunk$set(echo = FALSE)
options(scipen = 999)
library(lifecontingencies)
library(tidyverse)
library(lubridate)
library(readxl)
library(kableExtra)
library(xtable)
library(stringr)
library(magrittr) # uso de %<>% con funciones de dplyr
# library(xts)
# library(tinytex)

# Para paralelizar
library(future.apply)
plan(multicore)


# Se cargan las bases de datos

Afiliados_31_12_2021 <- read_excel("Planilla_Compañia_31_12_2021.xlsx")
Pensionados_31_12_2021 <- read_excel("Compañia_Pensionados_31_12_2021.xlsx", range = "A1:F5006")


# Tablas de decrementos

TablasDecrementosHombres <- read_excel("Tablas de decrementos.xlsx",
  sheet = "Hombres"
)
TablasDecrementosMujeres <- read_excel("Tablas de decrementos.xlsx",
  sheet = "Mujeres"
)


# Tablas de mortalidad dinámicas

TablaDinamica_lxsHombres <- as.data.frame(read_excel("TablaDinamica-lxs.xls",
  sheet = "Hombres"
))
TablaDinamica_lxsMujeres <- as.data.frame(read_excel("TablaDinamica-lxs.xls",
  sheet = "Mujeres"
))

# Se genera lista con las tablas actuariales de los hombres

ListaDeTablasHombres <- list()
for (j in 1:(length(TablaDinamica_lxsHombres) - 1)) {
  ListaDeTablasHombres[[j]] <- with(
    TablaDinamica_lxsHombres,
    new(
      "actuarialtable",
      interest = 0.06,
      x = TablaDinamica_lxsHombres[, 1],
      lx = TablaDinamica_lxsHombres[, j + 1],
      name = paste("E", (j - 1), sep = "")
    )
  )
}

names(ListaDeTablasHombres) <- paste("E", seq(0, 115), sep = "")

# Se genera lista con las tablas actuariales de las mujeres

ListaDeTablasMujeres <- list()
for (j in 1:(length(TablaDinamica_lxsMujeres) - 1)) {
  ListaDeTablasMujeres[[j]] <- with(
    TablaDinamica_lxsMujeres,
    new(
      "actuarialtable",
      interest = 0.06,
      x = TablaDinamica_lxsMujeres[, 1],
      lx = TablaDinamica_lxsMujeres[, j + 1],
      name = paste("E", (j - 1), sep = "")
    )
  )
}

names(ListaDeTablasMujeres) <- paste("E", seq(0, 115), sep = "")

# Se establece la echa de la evaluación

dia_de_evaluacion <- as.Date("31/12/2021", format = "%d/%m/%Y")

# Afiliados

# Cálculo de edades afiliados

edad <- floor(time_length(difftime(
  dia_de_evaluacion,
  as.Date(as.POSIXct(Afiliados_31_12_2021$Fecha_nacimiento), "UTC")
), "years"))

# Depuración de la columna 'Fecha_ingreso'

Afiliados_31_12_2021 %<>% mutate(Fecha_ingreso = paste(substr(Fecha_ingreso, 1, 4),
  "/", substr(Fecha_ingreso, 5, 6), "/", substr(Fecha_ingreso, 7, 8),
  sep = ""
))

# Depuración de la columna 'Fecha_nacimiento'

Afiliados_31_12_2021 %<>% mutate(Fecha_nacimiento = format(Fecha_nacimiento, "%Y/%m/%d"))

# Cálculo de antigüedad

antiguedad <- floor(time_length(difftime(
  dia_de_evaluacion,
  as.Date(
    Afiliados_31_12_2021$Fecha_ingreso,
    "%Y/%m/%d"
  )
), "years"))

# Inclusión de las variables de edad y antigüedad en la base de datos

Afiliados_31_12_2021 %<>% mutate("Edad" = edad, "Antiguedad" = antiguedad)

# Se calcula edad de los pensionados

Pensionados_31_12_2021 %<>% mutate(FEC_NAC = paste(substr(FEC_NAC, 1, 4),
  "/", substr(FEC_NAC, 5, 6), "/", substr(FEC_NAC, 7, 8),
  sep = ""
))

Pensionados_31_12_2021 %<>% mutate(FEC_RIG_PEN = paste(substr(FEC_RIG_PEN, 1, 4),
  "/", substr(FEC_RIG_PEN, 5, 6), "/", substr(FEC_RIG_PEN, 7, 8),
  sep = ""
))

edad <- floor(time_length(
  difftime(
    dia_de_evaluacion,
    as.Date(
      Pensionados_31_12_2021$FEC_NAC,
      "%Y/%m/%d"
    )
  ),
  "years"
))

tiempo_pension <- floor(time_length(
  difftime(
    dia_de_evaluacion,
    as.Date(
      Pensionados_31_12_2021$FEC_RIG_PEN,
      "%Y/%m/%d"
    )
  ),
  "years"
))

Pensionados_31_12_2021 %<>% mutate("Edad" = edad, "T_Pension" = tiempo_pension)

# se crean bases de datos según genero

afil_hombres <- Afiliados_31_12_2021 %>% filter(Sexo == "M")
pen_hombres <- Pensionados_31_12_2021 %>% filter(SEX == "M")
afil_mujeres <- Afiliados_31_12_2021 %>% filter(Sexo == "F")
pen_mujeres <- Pensionados_31_12_2021 %>% filter(SEX == "F")
inflacion <- 0.04
```

## Tablas de multiples decrementos


```{r}

ProMuerte <- function(q1, q2, q3, q4) {
  a <- q1 * ((-3 * q2 * q3 * q4) / 12 + 4 * (q2 * q3 + q3 * q4 + q4 * q2) / 12 - 6 * (q2 + q3 + q4) / 12 + 1)
  b <- q2 * ((-3 * q1 * q3 * q4) / 12 + 4 * (q1 * q3 + q3 * q4 + q4 * q1) / 12 - 6 * (q1 + q3 + q4) / 12 + 1)
  c <- q3 * ((-3 * q2 * q1 * q4) / 12 + 4 * (q2 * q1 + q1 * q4 + q4 * q2) / 12 - 6 * (q2 + q1 + q4) / 12 + 1)
  d <- q4 * ((-3 * q2 * q3 * q1) / 12 + 4 * (q2 * q3 + q3 * q1 + q1 * q2) / 12 - 6 * (q2 + q3 + q1) / 12 + 1)
  qx <- (a + b + c + d)

  return(data.frame("qx1" = a, "qx2" = b, "qx3" = c, "qx4" = d, "qxC" = qx))
}

# Se genera lista con las tablas de multiples decrementos de los hombres

MDListaDeTablasHombres <- list()
for (m in 1:116) {
  qxs <- ProMuerte(TablasDecrementosHombres$Invalidez, TablasDecrementosHombres$Jubilacion, TablasDecrementosHombres$Retiro, qxt(ListaDeTablasHombres[[m]], 0, c(1:116)))

  Tabladevida <- as.data.frame(qxs)

  Tabladevida$lx <- (1000000:(1000000 - 115))

  for (i in 1:115) {
    Tabladevida$lx[i + 1] <- Tabladevida$lx[i] - Tabladevida$lx[i] * Tabladevida$qxC[i]
  }

  Tabladevida$d1 <- Tabladevida$lx * Tabladevida$qx1
  Tabladevida$d2 <- Tabladevida$lx * Tabladevida$qx2
  Tabladevida$d3 <- Tabladevida$lx * Tabladevida$qx3
  Tabladevida$d4 <- Tabladevida$lx * Tabladevida$qx4

  Tabladevida$d4[1] + Tabladevida$lx[2]

  MDListaDeTablasHombres[[m]] <-
    new(
      "mdt",
      table = Tabladevida[, 7:10],
      name = paste("E", (m - 1), sep = "")
    )
}

names(MDListaDeTablasHombres) <- paste("E", seq(0, 115), sep = "")



# Se genera lista con las tablas de multiples decrementos de las mujeres

MDListaDeTablasMujeres <- list()
for (m in 1:116) {
  qxs <- ProMuerte(TablasDecrementosMujeres$Invalidez, TablasDecrementosMujeres$Jubilacion, TablasDecrementosMujeres$Retiro, qxt(ListaDeTablasMujeres[[m]], 0, c(1:116)))

  Tabladevida <- as.data.frame(qxs)

  Tabladevida$lx <- (1000000:(1000000 - 115))

  for (i in 1:115) {
    Tabladevida$lx[i + 1] <- Tabladevida$lx[i] - Tabladevida$lx[i] * Tabladevida$qxC[i]
  }

  Tabladevida$d1 <- Tabladevida$lx * Tabladevida$qx1
  Tabladevida$d2 <- Tabladevida$lx * Tabladevida$qx2
  Tabladevida$d3 <- Tabladevida$lx * Tabladevida$qx3
  Tabladevida$d4 <- Tabladevida$lx * Tabladevida$qx4

  Tabladevida$d4[1] + Tabladevida$lx[2]

  MDListaDeTablasMujeres[[m]] <-
    new(
      "mdt",
      table = Tabladevida[, 7:10],
      name = paste("E", (m - 1), sep = "")
    )
}

names(MDListaDeTablasMujeres) <- paste("E", seq(0, 115), sep = "")

rm(qxs)
```




## Escala salarial

```{r}
# Aqui voy a programar la tabla de escala salarial
# se debe hacer por sexo y por edad
# de momentos se calculará el promedio por edad
# Se estima una función lineal entre los dos puntos que faltan
# Pensando si hacerlo por splines
media_mujeres <- aggregate(afil_mujeres$Salario, list(afil_mujeres$Edad), FUN = mean)
media_hombres <- aggregate(afil_hombres$Salario, list(afil_hombres$Edad), FUN = mean)
j <- 2
while (j <= nrow(media_mujeres)) {
  diferencia <- media_mujeres$Group.1[j] - media_mujeres$Group.1[j - 1]
  if (diferencia != 1) {
    m <- (media_mujeres$x[j] - media_mujeres$x[j - 1]) /
      (media_mujeres$Group.1[j] - media_mujeres$Group.1[j - 1])
    b <- media_mujeres$x[j] - m * media_mujeres$Group.1[j]
    edad_faltantes <- media_mujeres$Group.1[j - 1] + (1:(diferencia - 1))
    montos <- m * edad_faltantes + b
    faltantes <- data.frame(Group.1 = edad_faltantes, x = montos)
    media_mujeres <- rbind(media_mujeres[1:j - 1, ], faltantes, media_mujeres[j:nrow(media_mujeres), ])
  }
  j <- j + 1
}
j <- 2
while (j <= nrow(media_hombres)) {
  diferencia <- media_hombres$Group.1[j] - media_hombres$Group.1[j - 1]
  if (diferencia != 1) {
    m <- (media_hombres$x[j] - media_hombres$x[j - 1]) /
      (media_hombres$Group.1[j] - media_hombres$Group.1[j - 1])
    b <- media_hombres$x[j] - m * media_hombres$Group.1[j]
    edad_faltantes <- media_hombres$Group.1[j - 1] + (1:(diferencia - 1))
    montos <- m * edad_faltantes + b
    faltantes <- data.frame(Group.1 = edad_faltantes, x = montos)
    media_hombres <- rbind(media_hombres[1:j - 1, ], faltantes, media_hombres[j:nrow(media_hombres), ])
  }
  j <- j + 1
}
# Mujeres
edad_m <- max(media_mujeres$Group.1)
sal_m <- rep(max(media_mujeres$x), 85 - edad_m)
sal_m <- data.frame(Group.1 = c((edad_m + 1):85, 18), x = c(sal_m, media_mujeres$x[1]))
media_mujeres %<>% rbind(sal_m)

# Hombres
edad_h <- max(media_hombres$Group.1)
sal_h <- rep(max(media_hombres$x), 85 - edad_h)
sal_h <- data.frame(Group.1 = (edad_h + 1):85, x = sal_h)
media_hombres %<>% rbind(sal_h)

# Ordenamiento
media_mujeres <- media_mujeres[order(media_mujeres$Group.1), ]
media_hombres <- media_hombres[order(media_hombres$Group.1), ]

# Unificacion
escala <- data.frame(Edad = 18:85, Hombres = media_hombres$x, Mujeres = media_mujeres$x)
min_m <- escala$Mujeres[1]
min_h <- escala$Hombres[1]
escala %<>% mutate(Hombres = Hombres / min_h, Mujeres = Mujeres / min_m)
write.csv(escala, "./Escala_edad.csv", row.names = FALSE)
```


## Caso por antigüedad 
```{r}
media_mujeres <- aggregate(afil_mujeres$Salario, list(afil_mujeres$Antiguedad), FUN = mean)
media_hombres <- aggregate(afil_hombres$Salario, list(afil_hombres$Antiguedad), FUN = mean)
j <- 2
while (j <= nrow(media_mujeres)) {
  diferencia <- media_mujeres$Group.1[j] - media_mujeres$Group.1[j - 1]
  if (diferencia != 1) {
    m <- (media_mujeres$x[j] - media_mujeres$x[j - 1]) /
      (media_mujeres$Group.1[j] - media_mujeres$Group.1[j - 1])
    b <- media_mujeres$x[j] - m * media_mujeres$Group.1[j]
    edad_faltantes <- media_mujeres$Group.1[j - 1] + (1:(diferencia - 1))
    montos <- m * edad_faltantes + b
    faltantes <- data.frame(Group.1 = edad_faltantes, x = montos)
    media_mujeres <- rbind(media_mujeres[1:j - 1, ], faltantes, media_mujeres[j:nrow(media_mujeres), ])
  }
  j <- j + 1
}
j <- 2
while (j <= nrow(media_hombres)) {
  diferencia <- media_hombres$Group.1[j] - media_hombres$Group.1[j - 1]
  if (diferencia != 1) {
    m <- (media_hombres$x[j] - media_hombres$x[j - 1]) /
      (media_hombres$Group.1[j] - media_hombres$Group.1[j - 1])
    b <- media_hombres$x[j] - m * media_hombres$Group.1[j]
    edad_faltantes <- media_hombres$Group.1[j - 1] + (1:(diferencia - 1))
    montos <- m * edad_faltantes + b
    faltantes <- data.frame(Group.1 = edad_faltantes, x = montos)
    media_hombres <- rbind(media_hombres[1:j - 1, ], faltantes, media_hombres[j:nrow(media_hombres), ])
  }
  j <- j + 1
}

media_mujeres <- rbind(media_mujeres, data.frame(Group.1 = c(45, 46), x = rep(media_mujeres$x[nrow(media_mujeres)])))
escala_antiguedad <- data.frame(Antiguedad = 0:46, Hombres = media_hombres$x, Mujeres = media_mujeres$x)
min_h <- escala_antiguedad$Hombres[1]
min_m <- escala_antiguedad$Mujeres[1]
escala_antiguedad %<>% mutate(Hombres = Hombres / min_h, Mujeres = Mujeres / min_m)
write.csv(escala_antiguedad, "./Escala_antiguedad.csv", row.names = FALSE)
```


# Estadistica

```{r}
# Ejemplo esperanza de vida
Edad <- 30
exn(ListaDeTablasHombres[[Edad + 1]], x = Edad, type = "curtate")
```



# Estocástico


## Afiliados

Para los personas afiliadas al plan ofrecido por la Compañía, se implementa una modificación de uno de los algortimos descritos en Racinello (1988) bajo un modelo de múltiples decrementos. El mencionado algoritmo permite simular la variable aleatoria $W_{x}$ del tiempo de trabajo residual de un empleado activo de edad $(x)$. En esencia, el método proporciona un criterio para, en un primer paso y dada una muestra de una distribución $\mathcal{U}(0,1)$, decidir si una persona de edad $(x)$ se llega a jubilar obligatoriamente, en cuyo caso resta solamente simular su tiempo de vida residual. En su defecto, el algoritmo proporciona una regla para asignar, de acuerdo a una segunda muestra de una distribución $\mathcal{U}(0,1)$, cuál de los decrementos restantes sucedió para que no se llegara a la edad máxima de jubilación. Como puede comprobarse, el método requiere a lo sumo dos muestras $\mathcal{U}(0,1)$ en aras de obtener una muestra de $W_{x}$.

Por otro lado, para simular $T_{x}$ en caso de jubilación, se optó por seguir el método de... (pendiente).

```{r}

# Implementación del algoritmo descrito en Racinello (1988)

# costo_afiliados_estoc(x){
  
  # Primera simulación de una distribución U(0,1)

  x <- 60

  u <- runif(1)
  
  # Vector de probabilidades de muerte simples
  
  q4_prima <- ListaDeTablasHombres[[x+1]]
  
  # Vector con probabilidades (q1, q2, q3, q4, q_Tau)
  
  qxs <- ProMuerte(TablasDecrementosHombres$Invalidez, TablasDecrementosHombres$Jubilacion, TablasDecrementosHombres$Retiro, qxt(ListaDeTablasHombres[[x+1]], 0, c(1:116)))

  q <- 1-prod(1-qxs[(x+1):(85),5]) # P(Wx <= 85-x-1)
  
  if(u > q) {# Criterio del algoritmo en caso de jubilación obligatoria
  
    # Se simula la vida residual (con el momento simple asociado)
    
    Tx <- rLife(1, q4_prime, 85, type = "Kx")
    
    monto_pension <- 1
    
  }else{# Criterio del algoritmo en caso de no jubilación obligaria  
  # Debe hallarse k tal que P(Wx<=k-1)<u<=P(W_x<=k)
  hallado <- F
  k <- 0
  q_ant <- 0
  while(hallado == F){
  q_nuevo <- 1 - (1-q_ant) * (1-qxs[(x+1+k),5]) # kqx^tau
  if(q_ant<u && u<=q_nuevo){
  hallado <- T  
  }
  k <- k+1
  print(k)
  q_ant <- q_nuevo
  }
  # Se genera una nueva muestra para determinar el decremento
  u <- runif(1)
  denominador <- sum(qxs[(x+k+1),1:4])
  qbar <- qxs[(x+k+1), 1:4]/denominador # vector probs. condicionales

  }


```



# Funcion para determinar pension de personas ya pensionadas

```{r}
pension_pen <- function(base_de_datos, sex, t_descuento, m, simulaciones) {
  v <- 1 / (1 + t_descuento)
  # aumento<-(1+0.03)*(1+aumento_real)
  edades <- base_de_datos$Edad
  montos <- base_de_datos$MON_PEN
  fn2 <- function(edad, monto) {
    # print("Hola")
    Edad <- edad
    suma <- 0
    simulacion <- simulaciones
    # monto<-monto*(v*aumento)^(max(jubilacion-Edad,0)) en este caso si se descomenta se calcula para los ya pensionados
    # monto<-monto
    ajuste <- 1
    j <- 1 / m
    i <- 1
    while (simulacion > 0) {
      if (sex) {
        probabilidad <- pxt(ListaDeTablasHombres[[(Edad + 1)]], x = edad, t = 1 / m)
      } else {
        probabilidad <- pxt(ListaDeTablasMujeres[[(Edad + 1)]], x = edad, t = 1 / m)
      }
      vivos <- sum(rbinom(n = simulacion, size = 1, prob = probabilidad))
      simulacion <- vivos
      edad <- edad + 1 / m
      suma <- suma + v^j * ajuste * vivos * 2^(i == 11)
      ajuste <- ajuste * (1 + inflacion)^(i == 12)
      j <- j + 1 / m
      i <- (1 + i) * (i < 12) + 1 * (i == 12)
    }
    return(monto * suma / simulaciones)
  }
  valores <- unlist(future_mapply(FUN = fn2, edad = edades, monto = montos, SIMPLIFY = FALSE))
  return(sum(valores))
}




```

## Calculo de pension estocastico
```{r}
(pension_pen_m <- pension_pen(pen_mujeres, FALSE, 0.07, 12, 1000))
(pension_pen_h <- pension_pen(pen_hombres, TRUE, 0.07, 12, 1000))

fileConn <- file("output.txt")
writeLines(paste("Estocastico:", "Mujeres", pension_pen_m, "Hombres", pension_pen_h, sep = " "), fileConn)
close(fileConn)
```


# Deterministico

# Funciones que nos sirven a ambos

```{r}
# porcentaje de pensión
porcentaje_de_pension <- function(antiguedad) {
  porcebtajeVejez <- c((antiguedad >= 5 & antiguedad < 10) * 0.10 +
    (antiguedad >= 10 & antiguedad < 15) * 0.15 +
    (antiguedad >= 15 & antiguedad < 20) * 0.20 +
    (antiguedad >= 20 & antiguedad < 25) * 0.25 +
    (antiguedad >= 25 & antiguedad < 30) * 0.30 +
    (antiguedad >= 30 & antiguedad < 35) * 0.35 +
    (antiguedad >= 35) * 0.4)
  return(porcebtajeVejez)
}


RebajoFondosInsuficientes <- function(MontodePension) {
  MontoRebajado <- c(
    MontodePension * 0.10 +
      (MontodePension >= 2293400) * 0.35 * MontodePension +
      (MontodePension >= 2866750) * 0.45 * MontodePension +
      (MontodePension >= 3583437.50) * 0.55 * MontodePension +
      (MontodePension >= 4479296.88) * 0.65 * MontodePension
  )
  if (MontoRebajado > MontodePension * 0.55) {
    return(MontodePension * 0.55)
  }
  return(MontoRebajado)
}
```

## Personal activo

```{r}

```


## Personas ya pensionadas

```{r}

```








